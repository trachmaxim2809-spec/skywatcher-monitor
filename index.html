<!DOCTYPE html>
<html>

<head>
    <title>SkyWatcher Alerts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
            background: #111;
        }

        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script>
        const map = L.map('map').setView([48.3, 31.1], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const firebaseConfig = { databaseURL: "https://skywatcher-e6b95-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('targets');

        let regionLayers = {};

        // Загружаем границы Украины
        fetch('https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/UKR/ADM1/geoBoundaries-UKR-ADM1.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: "#333", weight: 2, fillOpacity: 0.2, fillColor: "#222" },
                    onEachFeature: function (feature, layer) {
                        // Чистим название, чтобы совпадало с ответом ИИ
                        let name = feature.properties.shapeName.replace(' Oblast', '');
                        regionLayers[name] = layer;
                    }
                }).addTo(map);
            });

        db.on('child_added', (snapshot) => {
            const data = snapshot.val();

            // 1. Показываем точку цели (маркер)
            if (data.lat && data.lng) {
                L.circleMarker([data.lat, data.lng], {
                    radius: 8, color: 'yellow', fillColor: 'orange', fillOpacity: 1
                }).addTo(map).bindPopup(data.city).openPopup();
            }

            // 2. Закрашиваем область красным (как на фото)
            if (data.region && regionLayers[data.region]) {
                regionLayers[data.region].setStyle({
                    fillColor: '#ff4444',
                    fillOpacity: 0.6,
                    color: '#ff0000',
                    weight: 3
                });

                // Снимаем тревогу через 30 минут
                setTimeout(() => {
                    regionLayers[data.region].setStyle({ fillColor: "#222", fillOpacity: 0.2, color: "#333", weight: 2 });
                }, 1800000);
            }
        });
    </script>
</body>

</html>